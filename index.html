<!DOCTYPE html>
<html>
	<head>
		<title>PTT</title>
		<script src="Task.js"></script>
		<script src="Database.js"></script>
		<script>
			/**
			* Global array containing all jobs
			*/
			var jobs = [];
		
			/**
			* Format Date object to display the time properly
			*/
			function formatTime(tps) {
				var h = tps.getHours();
				var m = tps.getMinutes();
				var s = tps.getSeconds();
				return ((h>9)?"":"0")+h+":"+((m>9)?"":"0")+m+":"+((s>9)?"":"0")+s;
			}
			
			function formatDuration(ms,withSeconds){
			    var s = Math.floor(ms/1000);
		        var m = Math.floor(s/60);
		        var rs = s - m*60;
		        var h = Math.floor(m/60);
		        var rm = m - h*60;
		        var time = (h>0?(h>9?"":"0")+h+":":"") + ((h>0?(rm>9?"":"0"):"")+rm);
		        if ((withSeconds == undefined) || withSeconds) {
		            time += ":"+(rs>9?"":"0")+rs;
		        }
		        return time;
			}
			
			/**
			* Auto updated current Time display
			*/
			function showTime(){
				document.querySelector("#time").innerHTML = formatTime(new Date());
				setTimeout(showTime,1000);
			}
			
			/**
			* init
			*/
			document.addEventListener("DOMContentLoaded", showTime, false);
			document.addEventListener("DOMContentLoaded", function(){
				document.querySelector("#control #start").addEventListener("click", function(e){
					//pause currently running task
					if (jobs.length > 0) jobs[jobs.length-1].pause();
					// start a new task
					jobs.push(new Task());
					document.querySelector("#jobs").appendChild(jobs[jobs.length-1].getHTML());
				}, false);
				
				document.querySelector("#control #stop").addEventListener("click", function(e){
					//pause currently running task
					if (jobs.length > 0) jobs[jobs.length-1].pause();
				}, false);
			}, false);
			
			if ('openDatabase' in window){
				document.addEventListener("DOMContentLoaded", function(){
					
					Database.init();
					var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
					var offset=10;
					Database.load("current", function(task){
					    var theTask = new Task(task.start,task.project,task.desc,task.duration);
					    theTask.id = task.id;
						jobs.push(theTask);
						document.querySelector("#jobs").appendChild(theTask.getHTML());
					});
					Database.load("today", function(task){
					    var theTask = new Task(task.start,task.project,task.desc,task.duration);
					    
						var height = theTask.getPercentTime();
						svg.rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
						svg.rect.setAttribute("x", 0);
						svg.rect.setAttribute("y", offset);
						svg.rect.setAttribute("width",50);
						svg.rect.setAttribute("height", height);
						svg.appendChild(svg.rect);
						
						svg.line = document.createElementNS("http://www.w3.org/2000/svg", "line");
						svg.line.setAttribute("x1", 0);
						svg.line.setAttribute("y1", offset);
						svg.line.setAttribute("x2", 55);
						svg.line.setAttribute("y2", offset);
						svg.appendChild(svg.line);
						
						if(height > 10) {
						    svg.start = document.createElementNS("http://www.w3.org/2000/svg", "text");
						    svg.start.setAttribute("class","start");
						    svg.start.setAttribute("x",55);
						    svg.start.setAttribute("y",offset+5);
						    svg.start.textContent = theTask.getStartTime(false);
						    svg.appendChild(svg.start);
						    
						    svg.time = document.createElementNS("http://www.w3.org/2000/svg", "text");
						    svg.time.setAttribute("class","time");
						    svg.time.setAttribute("x",25);
						    svg.time.setAttribute("y",offset+height/2+5);
						    svg.time.setAttribute("style","text-anchor:middle");
						    svg.time.textContent = theTask.getElapsedTime(false);
						    svg.appendChild(svg.time);
						
						    svg.project = document.createElementNS("http://www.w3.org/2000/svg", "text");
						    svg.project.setAttribute("class","project");
						    svg.project.setAttribute("x",60);
						    svg.project.setAttribute("y",offset+height/2+5);
						    svg.project.textContent = theTask.project;
						    svg.appendChild(svg.project);
						}
						offset += height;
						
					});
					
					function normalize(val, norm){
					    return Math.round(val*norm*100)/100;
					}
					
					var aOffset = Math.PI/2;
					Database.load("today-project", function(project){
					    var angle = -2*Math.PI*project.dur/(8*60*60*1000);
					    var x1 = normalize(Math.cos(aOffset),100);
					    var y1 = normalize(-Math.sin(aOffset),100);
					    var x2 = normalize(Math.cos(aOffset+angle)- Math.cos(aOffset),100);
					    var y2 = normalize(Math.sin(aOffset) - Math.sin(aOffset+angle),100);
					    svg.camemberg = document.createElementNS("http://www.w3.org/2000/svg", "path");
					    svg.camemberg.setAttribute("d","M300,150 l"+x1+","+y1+" a100,100 10 1,1 "+x2+","+y2+" Z");
					    svg.appendChild(svg.camemberg);
					    
					    svg.project = document.createElementNS("http://www.w3.org/2000/svg", "text");
					    svg.project.setAttribute("class","project");
					    svg.project.setAttribute("x",300+normalize(Math.cos(aOffset + angle/2),70));
					    svg.project.setAttribute("y",150-normalize(Math.sin(aOffset + angle/2),70));
					    svg.project.setAttribute("style","text-anchor:middle");
					    svg.project.textContent = project.project;
					    svg.appendChild(svg.project);
					    
					    svg.time = document.createElementNS("http://www.w3.org/2000/svg", "text");
					    svg.time.setAttribute("class","time");
					    svg.time.setAttribute("x",300+normalize(Math.cos(aOffset + angle/2),120));
					    svg.time.setAttribute("y",150-normalize(Math.sin(aOffset + angle/2),120));
					    svg.time.setAttribute("style","text-anchor:middle");
					    svg.time.textContent = formatDuration(project.dur,false);
					    svg.appendChild(svg.time);
					    
					    aOffset += angle;
					});
					document.querySelector("#day").appendChild(svg);
					document.querySelector("#reset").addEventListener("click", function(e){
						Database.erase();
					});
				});
			}
		</script>
		<style>
			#time { font-family: Helvetica; font-size: 70px; margin: auto; width: 270px;}
			.timer{background-color: blue; display: inline-block; height: 12pt; margin:0 5px}
			.startTime{font-weight:bold}
			.job input{border:none; margin: 0 1ex; width:0ex;}
			section {min-height:100px; border:thin solid grey}
			rect{fill:lightBlue}
			text.time{}
			line{stroke:blue}
			path{fill:lightBlue;stroke:blue}
		</style>
	</head>
	<body>
		<div id="time">0:00:00</div>
		<input id="reset" type="button" value="reset">
		<div id="jobs">
			<form id="control">
				<input id="start" type="button" value="start">
				<input id="stop" type="button" value="stop">
			</form>
		</div>
		<section id="day"></section>
	</body>
</html>
